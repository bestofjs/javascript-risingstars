---
// GET request made when pushing the "Show more" button
// /partials/get-extra-projects/?category=framework&language=en&year=2022
import { z } from "astro:content";
import ProjectList from "~/components/project-list.astro";
import { fetchPageProps } from "~/fetch-page-props";

export const partial = true;
export const prerender = false;

const searchSchema = z.object({
  year: z.coerce.number().int().min(2016).max(2023),
  category: z.string(),
  language: z.string(),
  offset: z.coerce.number().int().default(5),
});

const url = new URL(Astro.request.url);
const searchParams = new URLSearchParams(url.search);

const {
  year,
  category: categorySlug,
  language,
  offset,
} = searchSchema.parse({
  year: searchParams.get("year"),
  category: searchParams.get("category"),
  language: searchParams.get("language"),
  offset: searchParams.get("offset"),
});

const { projectsByTag } = await fetchPageProps(year, language);

const allProjects = projectsByTag[categorySlug];
const extraProjects = allProjects.slice(offset);
console.log(
  offset,
  extraProjects.map((p) => p.name)
);
---

<ProjectList
  projects={extraProjects}
  year={year}
  language={language}
  offset={offset}
  starDeltaReference={allProjects[0].delta}
/>
