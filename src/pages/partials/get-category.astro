---
// GET request made when navigating between years, inside a category
// /partials/category/?category=framework&language=en&year=2022
import { z } from "astro:content";

import Category from "~/components/category.astro";
import { fetchPageProps } from "~/fetch-page-props";

export const partial = true;
export const prerender = false;

const searchSchema = z.object({
  year: z.coerce.number().int().min(2016).max(2023),
  category: z.string(),
  language: z.string(),
});

const url = new URL(Astro.request.url);
const searchParams = new URLSearchParams(url.search);

const {
  year,
  category: categorySlug,
  language,
} = searchSchema.parse({
  year: searchParams.get("year"),
  category: searchParams.get("category"),
  language: searchParams.get("language"),
});

const { projectsByTag, categories } = await fetchPageProps(year, language!);

const projects = projectsByTag[categorySlug];
const category = categories.find((cat) => cat.key === categorySlug);
---

<Category
  projects={projects}
  year={year}
  language={language}
  category={category}
/>
