---
// GET request made to load categories when:
// - navigating between years inside a category
// - lazy loading an extra category at the bottom of the page
import invariant from "tiny-invariant";
import { z } from "astro:content";

import Section from "~/components/category.astro";
import ProjectList from "~/components/project-list.astro";
import { fetchPageProps } from "~/fetch-page-props";
import { languageCodeSchema, yearSchema } from "~/schema";
import { getAllCategories } from "~/settings";

export const partial = true;
export const prerender = true;

export async function getStaticPaths() {
  const categories = await getAllCategories();
  return categories.map((category) => ({
    params: {
      year: category.year.toString(),
      language: category.language,
      category: category.category.key,
    },
  }));
}

const searchSchema = z.object({
  year: yearSchema,
  language: languageCodeSchema,
  category: z.string(),
});

const {
  year,
  category: categorySlug,
  language,
} = searchSchema.parse(Astro.params);

const { projectsByTag, categories } = await fetchPageProps(year, language!);

const projects = projectsByTag[categorySlug];
const category = categories.find((cat) => cat.key === categorySlug);
invariant(category, `Category not found: ${categorySlug}`);
const offset = category?.limit || 5;
const extraProjects = projects.slice(offset);
---

<Section
  projects={projects}
  year={year}
  language={language}
  category={category}
/>

<div class="extra-projects">
  <ProjectList
    projects={extraProjects}
    year={year}
    language={language}
    offset={offset}
    starDeltaReference={projects[0].delta}
  />
</div>
