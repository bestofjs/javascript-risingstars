---
// GET request made when navigating between years, inside a category
// /partials/category/?category=framework&language=en&year=2022
import { getEntry, z } from "astro:content";
import settings from "~/settings/years-setup.json";

import Category from "~/components/category.astro";
import { fetchPageProps } from "~/fetch-page-props";

export const partial = true;
export const prerender = true;

export async function getStaticPaths() {
  const currentYear = settings.find((year) => year.current)!.year;
  const collectionItem = await getEntry("categories", currentYear.toString());
  const categorySlugs = collectionItem!.data.map((item) => item.key);
  const paths = categorySlugs.map((category) => ({
    params: { category, year: currentYear, language: "en" },
  }));
  return paths;
}

const searchSchema = z.object({
  year: z.coerce.number().int().min(2016).max(2023),
  category: z.string(),
  language: z.string(),
});

const {
  year,
  category: categorySlug,
  language,
} = searchSchema.parse(Astro.params);

const { projectsByTag, categories } = await fetchPageProps(year, language!);

const projects = projectsByTag[categorySlug];
const category = categories.find((cat) => cat.key === categorySlug);
---

<Category
  projects={projects}
  year={year}
  language={language}
  category={category}
/>
